---
name: Publish Extension

"on":
  workflow_dispatch:
    inputs:
      releaseType:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  lint:
    uses: ./.github/workflows/reusable/lint.yml
    permissions:
      contents: read

  test:
    uses: ./.github/workflows/reusable/test.yml
    permissions:
      contents: read

  build:
    uses: ./.github/workflows/reusable/build.yml
    needs: [lint, test]
    permissions:
      contents: read

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run package

      - name: Validate VSCE_PAT secret
        run: |
          if [ -z "${{ secrets.VSCE_PAT }}" ]; then
            echo "::error::VSCE_PAT secret is not set. Please add the secret to your repository settings."
            echo "To publish to VS Code Marketplace, you need to:"
            echo "1. Create a Personal Access Token at https://dev.azure.com"
            echo "2. Add it as a repository secret named 'VSCE_PAT'"
            echo "3. See: https://code.visualstudio.com/api/working-with-extensions/publishing-extension"
            exit 1
          fi

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: npx @vscode/vsce publish ${{ inputs.releaseType }} --no-git-tag-version
